## Deployment(배포)

배포에는 여러가지 방법이 있음

1. 빅뱅 배포

- 애플리케이션의 전체 또는 대부분을 한 번에 업데이트
  - 버전1에서 버전 2로 한꺼번에 바꾸는 케이스
  - 시스템을 일시 중지하고 전체를 다 바꾸는 것

2. 롤링 배포 (단계적 배포)

- 어플리케이션의 이전 버전을 새 버전로 점진적으로 교체하는 것
  - ![image-20210308103843533](C:\Users\MIN\AppData\Roaming\Typora\typora-user-images\image-20210308103843533.png)

- 새 버전과 이전 버전이 공존하기 때문에 쉽게 롤 백 할 수 있다

3. Blue-green, Red-black, A/B 배포

- 두 개의 동일한 프로덕션 환경이 병렬로 작동
- 하나는 모든 트래픽을 수신하는 실행상태, 다른 하나는 복제본이면서 유휴 상태로 존재

로드 밸런서가 있어서![image-20210308104131818](C:\Users\MIN\AppData\Roaming\Typora\typora-user-images\image-20210308104131818.png)

둘 다 동일하게 구성되어 있음

새로운 버전의 애플리케이션은 그린 환경에 배포되고 기능 및 성능 테스트를 수행

테스트 결과가 성공이면 어플리케이션의 트래픽을 파란색에서 초록색으로 라우팅(변경)한다

![image-20210308104523437](C:\Users\MIN\AppData\Roaming\Typora\typora-user-images\image-20210308104523437.png)

초록색이 활성화된 후 문제가 발생하면 트래픽을 다시 파란색으로 라우팅

BLue-Green 배포에서는 두 시스템 모두가 동일한 지속 계층 또는 데이터베이스 백엔드 사용

계속 유지되는 것이 중요

4. 카나리아(canary) 배포

- 프로덕션 인프라의 작은 부분에 새 애플리케이션 코드를 배포해서 소수의 사용자만 해당 애플리케이션으로 라우팅
- 보고된 오류가 없는 새 버전은 나머지 인프라에 점차 롤 아웃

![image-20210308104942254](C:\Users\MIN\AppData\Roaming\Typora\typora-user-images\image-20210308104942254.png)

 Amazon API Gateway

- 개발자가 규모와 관계없이 API 를 쉽게 생성, 게시, 유지 관리, 모니터링, 보안유지를 할 수 있도록 하는 완전관리형 서비스
  - 여기서 말하는 API는 어플리케이션이 백엔드 서비스의 데이터, 비즈니스 로직 또는 기능에 접근할 수 있도록 해주는 역할
  - 일반 유저가 사용하는 응용 프로그램

-  만들어놓은 API를 AWS를 알아서 관리해줌



Iaas 를 주로 다룬다 - AWS 인프라 구축 가이드

서버리스 아키텍쳐를 주로 다룬다 - 마이크로서비스 인 액션

키 생성 시 개인키와 공개키를 부여함

공개 키: EC2 인스턴스에 보관

개인 키 : 사용자가 접속 시도할 수 있는 제공 키

공개 키와 개인 키가 일치 시 접속 가능

키 쌍 = 개인키+공개키



EC2 인스턴스 생성 및 서버 환경 구성

node -e "console.log('Running Node.js ' + process.version)"

뒤에 나오는 문자열을 자바 스크립트 명령어로 실행

running node js를 실행하라+ 프로세스의 버전 붙여서





**#2 웹 서버와 웹 애플리케이션 서버로 이원화**

웹 서버 ⇒ nginx → 정적 자원 요청에 대한 응답

웹 애플리케이션 서버 ⇒ Phusion Passenger → 응용 프로그램의 실행 결과를 반환





-----------

#### AWS Lambda Handler

>  이벤트를 처리하는 함수 코드의 메서드

- 함수 호출 시 람다에서 핸들러 메서드 실행
- 핸들러가 존재/응답 반환 시 이벤트 처리에 사용 가능



index.js

```js
exports.handler =  async function(event, context) {
  console.log("EVENT: \n" + JSON.stringify(event, null, 2))
  return context.logStreamName
}
```

> 이벤트 객체의 내용을 로깅하고 로그의 위치 반환하는 함수



- 핸들러 설정값: 파일 이름/내보낸 핸들러 모듈 이름

  - 점으로 구분됨

    - 해당 예시에서 콘솔의 기본값

      - index.handler

        => index.js 에 의해 내보내진 handler 모듈

- 런타임은 3개의 인수를 핸들러 메서드에 전달

  - 첫 번째 인수

    - 호출자로부터 정보가 포함된 `event` 객체

    - Invoke(람다 함수 실행)를 호출할 때 호출자가 JSON 형식 문자열로 전달

      => 런타임은 해당 정보를 객체로 변환

      - 이벤트 구조는 서비스별로 상이

  - 두 번째 인수

    - 컨텍스트 객체 (Node.js)
      - 호출, 함수 및 실행 환경에 관한 정보를 제공하는 메서드 및 속성들을 제공
      - 함수: 컨텍스트 객체로부터 로그 스트림의 이름을 가져와서 호출자에게 반환
        - AWS Lambda는 자동으로 Lambda 함수를 모니터링하고 함수 지표를 Amazon CloudWatch로 보냄
        - Lambda 함수는 함수의 각 인스턴스에 대한 CloudWatch Logs 로그 그룹 및 로그 스트림과 함께 제공

  - 세 번째 인수

    - Callback

      - 응답 전송 위해 비동기 이외의 핸들러에서 호출할 수 있는 함수

        - 비동기 이외의 핸들러: 이벤트 루프가 비어 있거나 함수 제한 시간을 초과할 때까지 함수 실행이 계속됨

      - 콜백 함수는 두 개의 인수, `Error` 및 응답을 사용

      - 호출하면 Lambda는 이벤트 루프가 비워질 때까지 기다린 다음 응답이나 오류를 호출자에게 반환

      - 응답 객체는 `JSON.stringify`와 호환되어야 함

      - 비동기 핸들러의 경우, `callback`을 사용하는 대신 응답, 오류 또는 promise를 런타임에 반환

      - 비동기 핸들러의 경우, `return` 및 `throw`를 사용하여 응답 또는 오류를 각각 전송 가능

        

